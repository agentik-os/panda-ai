name: "CodeQL Security Scanning"

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
    branches: ["main", "master", "develop"]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: "0 0 * * 1"

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript"]
        # CodeQL supports: 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby'
        # Learn more about CodeQL language support at https://aka.ms/codeql-docs/language-support

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # If you wish to specify custom queries, you can do so here or in a config file.
          # By default, queries listed here will override any specified in a config file.
          # Prefix the list here with "+" to use these queries and those in the config file.

          # For more details on CodeQL's query packs, refer to: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
          queries: security-and-quality,security-extended

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build
        continue-on-error: true # Continue even if build fails to still scan source

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ github.workspace }}/../results/javascript.sarif
        continue-on-error: true

  # Additional job to check for specific vulnerability patterns
  custom-scan:
    name: Custom Security Checks
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."
          # Check for common secret patterns
          if grep -r -E "(api[_-]?key|apikey|api[_-]?secret|password|passwd|pwd|secret[_-]?key|access[_-]?token|auth[_-]?token)['\"]?\s*[:=]\s*['\"][^'\"]{8,}" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md" || true; then
            echo "‚ö†Ô∏è Warning: Possible hardcoded secrets detected"
            echo "Please review the findings above"
          fi

      - name: Check for SQL injection patterns
        run: |
          echo "Checking for SQL injection vulnerabilities..."
          # Look for direct string concatenation in SQL queries
          if grep -r -E "(query|execute)\(.*\+.*\)" packages/runtime --include="*.ts" --include="*.js" || true; then
            echo "‚ö†Ô∏è Warning: Possible SQL injection vulnerability (string concatenation in queries)"
          fi

      - name: Check for XSS vulnerabilities
        run: |
          echo "Checking for XSS vulnerabilities..."
          # Look for innerHTML usage without sanitization
          if grep -r -E "innerHTML\s*=" packages/dashboard --include="*.tsx" --include="*.ts" --exclude="*.test.*" || true; then
            echo "‚ö†Ô∏è Warning: Possible XSS vulnerability (innerHTML usage)"
            echo "Consider using textContent or DOMPurify"
          fi

      - name: Check for path traversal
        run: |
          echo "Checking for path traversal vulnerabilities..."
          # Look for file operations with user input
          if grep -r -E "(readFile|writeFile|unlink|rmdir)\(.*req\.(body|params|query)" packages/ --include="*.ts" --include="*.js" || true; then
            echo "‚ö†Ô∏è Warning: Possible path traversal vulnerability"
            echo "Validate and sanitize file paths from user input"
          fi

      - name: Check for insecure crypto
        run: |
          echo "Checking for cryptographic issues..."
          # Look for MD5/SHA1 usage
          if grep -r -E "createHash\(['\"]md5|createHash\(['\"]sha1" packages/ --include="*.ts" --include="*.js" || true; then
            echo "‚ö†Ô∏è Warning: Weak cryptographic algorithm detected (MD5/SHA1)"
            echo "Use SHA-256 or stronger"
          fi

          # Look for insecure random
          if grep -r -E "Math\.random\(\)" packages/runtime --include="*.ts" --include="*.js" --exclude="*.test.*" || true; then
            echo "‚ö†Ô∏è Warning: Insecure random number generation"
            echo "Use crypto.randomBytes() for security-sensitive operations"
          fi

      - name: Check for command injection
        run: |
          echo "Checking for command injection vulnerabilities..."
          # Look for shell command execution with user input
          if grep -r -E "(exec|spawn|execFile)\(.*\`.*\$\{" packages/ --include="*.ts" --include="*.js" || true; then
            echo "‚ö†Ô∏è Warning: Possible command injection vulnerability"
            echo "Never use template literals with user input in shell commands"
          fi

  # Security summary comment on PR
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [analyze, custom-scan]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Comment PR with security summary
        uses: actions/github-script@v7
        with:
          script: |
            const workflow_run = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'codeql.yml',
              per_page: 1
            });

            const body = `## üîí CodeQL Security Scan Completed

            ‚úÖ Automated security scanning has been performed on this PR.

            ### Scanned for:
            - SQL Injection
            - Cross-Site Scripting (XSS)
            - Path Traversal
            - Cryptographic Misuse
            - Command Injection
            - Hardcoded Secrets
            - Insecure Dependencies

            View full results in the [Security tab](${context.payload.repository.html_url}/security/code-scanning).

            ---
            *Automated by CodeQL ¬∑ [Learn more](https://codeql.github.com/)*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
